(()=>{$((function(){var r;window.onpopstate=function(e){history.forward()},history.pushState({confirm:!1},"Not checked",""),history.pushState({confirm:!0},"Checked",""),history.back(),$("#btn-home").off("click"),$("#btn-home").on("click",(function(){var e=window.location.origin+"/clear_session";window.location.href=e})),$(".payment-method").off("change"),$(".payment-method").on("change",(function(){"credit-card"==$(this).prop("id")?$(".credit-card").show():$(".credit-card").hide()})),$("#card-number, #card-expire, #card-secret").off("keypress"),$("#card-number, #card-expire, #card-secret").on("keypress",(function(e){(e.which<48||e.which>57)&&e.preventDefault()})),$(".card").on("show.bs.collapse",(function(){$(this).find(".payment-method").prop("checked",!0)})),$('[data-toggle="collapse"]').on("click",(function(e){"nav"!==$(this).attr("id")&&($(this).parents(".accordion").find(".collapse.show")&&$(this).index('[data-toggle="collapse"]')==$(".collapse.show").index(".collapse")&&e.stopPropagation())})),$(".custom-link").off("click"),$(".custom-link").on("click",(function(){Swal.fire({confirmButtonColor:"#d7751e",html:'<div class="hint-content"><div><div class="hint-head">セキュリティコードとは、カード裏面の署名欄やカード表面のカード番号近くに記載されている3桁または4桁の数字です</div><div  class="hint-title">VISA/Mastercard/JCB/Diners</div><div class="hint-align"><img src="sunsun/imgs/hint-visa.png" /></div><div  class="hint-title">American Express</div><div class="hint-align"><img src="sunsun/imgs/hint-ame.png" /></div></div></div>',showCloseButton:!0,showConfirmButton:!1,customClass:"swal-height",confirmButtonText:"閉じる",showClass:{popup:"animated fadeInDown faster"},hideClass:{popup:"animated fadeOutUp faster"},cancelButtonText:'<i class="fa fa-thumbs-down"></i>',allowOutsideClick:!1})})),$("#card-number").off("keyup"),$("#card-number").on("keyup",(function(e){if(0!==$("#card-number").val().length){switch($("#card-number").val($("#card-number").val().replace(/\D/g,"").replace(/(\d{4})/g,"$1 ").trim()),function(e){if(!function(e){if(!/^[\d\-\s]+$/.test(e))return!1;for(var a=0,r=0,t=!1,n=e.replace(/\D/g,""),s=n.length-1;s>=0;s--){var i=n.charAt(s);r=parseInt(i,10),t&&(r*=2)>9&&(r-=9),a+=r,t=!t}return a%10==0}(e))return"";for(var a="",r=[{regEx:/^4[0-9]{5}/gi,cardType:"VISA"},{regEx:/^5[1-5][0-9]{4}/gi,cardType:"MASTERCARD"},{regEx:/^3[47][0-9]{3}/gi,cardType:"AMEX"},{regEx:/^(?:2131|1800|35\d{3})\d{11}$/gi,cardType:"JCB"}],t=0;t<r.length;t++)if(e.match(r[t].regEx)){a=r[t].cardType;break}if(0===e.indexOf("50")||0===e.indexOf("60")||0===e.indexOf("65"))for(var n="508500-508999|606985-607984|608001-608500|652150-653149".split("|"),s=0;s<n.length;s++){var i=parseInt(n[s].split("-")[0],10),o=parseInt(n[s].split("-")[1],10);if(e.substr(0,6)>=i&&e.substr(0,6)<=o&&e.length>=6){a="RUPAY";break}}return a}($("#card-number").val().replace(/\D/g,""))){case"VISA":"VISA"!==r&&$(".card-img").html('<img src="sunsun/svg/cc-visa.svg" class="img-fluid scale-image" alt="">'),r="VISA";break;case"MASTERCARD":"MASTERCARD"!==r&&$(".card-img").html('<img src="sunsun/svg/cc-mastercard.svg" class="img-fluid scale-image" alt="">'),r="MASTERCARD";break;case"AMEX":"AMEX"!==r&&$(".card-img").html('<img src="sunsun/svg/cc-amex.svg" class="img-fluid scale-image" alt="">'),r="AMEX";break;case"JCB":"JCB"!==r&&$(".card-img").html('<img src="sunsun/svg/cc-jcb.svg" class="img-fluid scale-image" alt="">'),r="JCB";break;default:"NONE"!==r&&$(".card-img").html('<img src="sunsun/svg/cc-blank.svg" class="img-fluid scale-image" alt="">'),r="NONE"}$(this).parent().find("span:first-child").css("display","inline"),$(this).removeClass("typing-none"),$(this).addClass("typing")}else $(this).parent().find("span:first-child").css("display","none"),$(this).removeClass("typing"),$(this).addClass("typing-none")})),$("#card-secret").off("keyup"),$("#card-secret").on("keyup",(function(){if(0!==$("#card-secret").val().length){$(this).parent().find("span:first-child").css("display","inline"),$(this).removeClass("typing-none"),$(this).addClass("typing");var e=$("#card-secret").val().replace(/\D/g,"");$("#card-secret").val(e)}else $(this).parent().find("span:first-child").css("display","none"),$(this).removeClass("typing"),$(this).addClass("typing-none")})),$("#make_payment").off("click"),$("#make_payment").on("click",(function(){t()}));var t=function(){"1"===$("input[type=radio][name=payment-method]:checked").val()?a():e()}}));var e=function(){var e=$("form.booking").serializeArray();$("#Token").val(""),$.ajax({url:"/make_payment",type:"POST",data:e,dataType:"text",beforeSend:function(){loader.css({display:"block"})},success:function(e){void 0!==(e=JSON.parse(e)).error?(Swal.fire({icon:"warning",text:" 入力した内容を確認してください。",confirmButtonColor:"#d7751e",confirmButtonText:"閉じる",width:350,showClass:{popup:"animated zoomIn faster"},hideClass:{popup:"animated zoomOut faster"},allowOutsideClick:!1}),$("p.note-error").remove(),$(".validate_failed").removeClass("validate_failed"),$.each(e.error,(function(e,a){switch($("#"+a).addClass("validate_failed"),a){case"name":$("#"+a).parent().after('<p class="note-error node-text"> お名前をカタカナで入力してください。</p>');break;case"phone":$("#"+a).parent().after('<p class="note-error node-text"> 電話番号は数字のみを入力してください。</p>');break;case"email":$("#"+a).parent().after('<p class="note-error node-text"> 入力したメールアドレスを確認してください。</p>')}})),$.each(e.clear,(function(e,a){$("#"+a).removeClass("validate_failed")}))):void 0!==e.status&&"success"==e.status?($("#bookingID").val(e.message.bookingID),$("#tranID").val(e.message.tranID),$("#completeForm").submit()):void 0!==e.status&&"error"==e.status&&Swal.fire({icon:"warning",text:e.message,confirmButtonColor:"#d7751e",confirmButtonText:"閉じる",width:350,showClass:{popup:"animated zoomIn faster"},hideClass:{popup:"animated zoomOut faster"},allowOutsideClick:!1})},complete:function(){loader.css({display:"none"})},error:function(e){419===e.status&&(window.location.href.includes("admin")?Swal.fire({target:"#edit_booking",text:"セッションがタイムアウトされました。ウェブサイトをリロードしてください。",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d7751e",cancelButtonColor:"#343a40",confirmButtonText:"はい",cancelButtonText:"いいえ",width:350,showClass:{popup:"animated zoomIn faster"},hideClass:{popup:"animated zoomOut faster"},allowOutsideClick:!1}).then((function(e){e.value&&window.location.reload(!0)})):Swal.fire({text:"セッションがタイムアウトされました。ウェブサイトをリロードしてください。",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d7751e",cancelButtonColor:"#343a40",confirmButtonText:"はい",cancelButtonText:"いいえ",width:350,showClass:{popup:"animated zoomIn faster"},hideClass:{popup:"animated zoomOut faster"},allowOutsideClick:!1}).then((function(e){e.value&&window.location.reload(!0)})))}})};function a(){if(""!=function(e){if(!function(e){if(!/^[\d\-\s]+$/.test(e))return!1;for(var a=0,r=0,t=!1,n=e.replace(/\D/g,""),s=n.length-1;s>=0;s--){var i=n.charAt(s);r=parseInt(i,10),t&&(r*=2)>9&&(r-=9),a+=r,t=!t}return a%10==0}(e))return"";for(var a="",r=[{regEx:/^4[0-9]{5}/gi,cardType:"VISA"},{regEx:/^5[1-5][0-9]{4}/gi,cardType:"MASTERCARD"},{regEx:/^3[47][0-9]{3}/gi,cardType:"AMEX"},{regEx:/^(?:2131|1800|35\d{3})\d{11}$/gi,cardType:"JCB"}],t=0;t<r.length;t++)if(e.match(r[t].regEx)){a=r[t].cardType;break}if(0===e.indexOf("50")||0===e.indexOf("60")||0===e.indexOf("65"))for(var n="508500-508999|606985-607984|608001-608500|652150-653149".split("|"),s=0;s<n.length;s++){var i=parseInt(n[s].split("-")[0],10),o=parseInt(n[s].split("-")[1],10);if(e.substr(0,6)>=i&&e.substr(0,6)<=o&&e.length>=6){a="RUPAY";break}}return a}($("#card-number").val().replace(/\D/g,""))){payment_init();var e=$("#card-number").val().replace(/\D/g,""),a=$("#expire-year").val().toString()+$("#expire-month").val().toString(),r=$("#card-secret").val().replace(/\D/g,"");Multipayment.getToken({cardno:e,expire:a,securitycode:r,tokennumber:1},execPurchase)}else $("#card-number").addClass("error"),$("#card-secret").addClass("error"),$("#expire-month").addClass("error"),$("#expire-year").addClass("error"),$("#card-number").after('<p class="note-error node-text">正しいカード番号を入力してください。</p>')}"undefined"==typeof execPurchase&&(execPurchase=function(a){$("p.note-error").remove(),"000"!=a.resultCode?($("#card-number").addClass("error"),$("#card-secret").addClass("error"),$("#expire-month").addClass("error"),$("#expire-year").addClass("error"),$("#card-number").after('<p class="note-error node-text">正しいカード番号を入力してください。</p>')):($("#card-number").removeClass("error"),$("#card-secret").removeClass("error"),$("#expire-month").removeClass("error"),$("#expire-year").removeClass("error"),$("#Token").val(a.tokenObject.token),e())})})();